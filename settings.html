<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="./css/photon.css">
    <link rel="stylesheet" href="./settingStyle.css">
    <title>Connection Settings</title>
</head>
<body>
    <form id="form" >
        <div class="dialog" id="dialog">
            <h3 >You have entered an invalid IP address!</h3>
            <button type="button" onclick="closeDialog()" id="dialogBtn">X</button>
        </div>
        <div class="container">
            <div class="form-group">
                <label for="ip">IP Addresss</label>
                <input type="text" id="ip" name="ip" autofocus >
            </div>
            <div class="form-group">
                <label for="protocol">Protocol</label>
                <select type="number" id="protocol" name="protocol" >
                    <option value="23">Telnet</option>
                    <option value="22">SSH</option>
                </select>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="password" id="username" name="username"  >
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" autofocus >
            </div>
        </div>
        <button type="button" onclick="clearFields()" class="btn  save clear">Clear</button>
        <button type="submit" class="btn save">Save</button>
        <p>*If the field is blank, the default will be used.</p>
    </form>
    <script defer>
        const { ipcRenderer } = require('electron')
        const settings = require('electron-settings'); 

        var key= process.env.MY_SECRET_KEY;
        var encryptor = require('simple-encryptor')(key);

        //gdije se cuvajua seting podaci na korisnikoj opremi
        //console.log('File used for Persisting Data - ' +
        //     settings.file()); 

        //za dobijenja settings podataka nakon
        //pojavljivanja setting windowa
        settings.get('key').then(data => {
            ip.value=data.strIp
            protocol.value=data.strProtocol
            username.value=encryptor.decrypt(data.strUsername) 
            password.value=encryptor.decrypt(data.strPassword) 
        }) 

        //dohvat html lemente
        const form=document.getElementById("form")
        const ip = document.getElementById("ip")
        const username = document.getElementById("username")
        const password = document.getElementById("password")
        const protocol= document.getElementById("protocol")
        var dialog = document.getElementById("dialog")
        var dialogBtn = document.getElementById("dialogBtn")

        form.addEventListener("submit", submitFunction)

        //after clicking save butoon
        function submitFunction(e){
            //stop default submit to file
            e.preventDefault();

            //validate ip address
            //ako postoji string i ako nije validan return
            //from submit
            if(ip.value && !validateIPaddress(ip.value)){
                return
            }
            

            //ako je passwor epmty field, do nothing
            //a ako postoji encrytpuj
            password.value= password.value?
                encryptor.encrypt(password.value):
                password.value;

            //the same for username
            username.value = username.value ?
                encryptor.encrypt(username.value) :
                username.value;
            
            //izabran je setSYnc tako da se prvo to
            //izvrsi prije dole closing windowa
            settings.setSync('key', {
                strIp: ip.value, 
                strProtocol: protocol.value, 
                strUsername: username.value, 
                strPassword: password.value}); 
            
            //send message to main.js to close this window
            ipcRenderer.invoke("settings") 
        }

        //clear button ne zatvara settings window, wec mora save
        function clearFields(){
            form.reset()
        }


        function validateIPaddress(ipaddress) {
            if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipaddress)) {
                return (true)
            }
            //ako je false pokazi dialog
            dialog.style.transform = "translateX(0)"
            return (false)
        }

        //zatvori diajlog
        function closeDialog(){
            dialog.style.transform = "translateX(-100%)"
        }

    </script>
</body>
</html>